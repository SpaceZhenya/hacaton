<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>3D Shooter — прицел по клику</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #crosshair {
      position: absolute; top: 50%; left: 50%;
      width: 20px; height: 20px;
      margin: -10px 0 0 -10px;
      pointer-events: none;
      background: url('data:image/svg+xml;utf8,\
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20">\
          <circle cx="10" cy="10" r="2" fill="white"/>\
        </svg>'
      ) no-repeat center;
    }
    #kills {
      position: absolute; top: 10px; left: 10px;
      color: white; font-size: 18px; text-shadow: 0 0 5px black;
    }
  </style>
</head>
<body>
  <div id="crosshair"></div>
  <div id="kills">Убито: 0</div>

  <script src="https://unpkg.com/three@0.153.0/build/three.min.js"></script>
  <script>
    let scene, camera, renderer;
    const player = new THREE.Group();
    let bullets = [], targets = [], kills = 0;
    const clock = new THREE.Clock();
    const move = { forward: 0, turn: 0 };
    const speed = 8, turnSpeed = 2.5;

    // Raycaster для кликов
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const groundPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x20232a);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5,10,7.5);
      scene.add(light);

      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(200,200),
        new THREE.MeshStandardMaterial({ color: 0x808080 })
      );
      floor.rotation.x = -Math.PI/2;
      scene.add(floor);

      // low-poly человек
      createLowPolyPlayer();
      scene.add(player);
      player.position.set(0,0,0);

      createBase();
      createTargets();
      setupControls();
      window.addEventListener('resize', onResize);
    }

    function createLowPolyPlayer() {
      const mat = new THREE.MeshStandardMaterial({ color: 0x00aa00 });
      const torso = new THREE.Mesh(new THREE.BoxGeometry(0.5,1,0.3), mat);
      torso.position.y = 1;
      player.add(torso);

      const head = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3), mat.clone());
      head.position.y = 1.6;
      player.add(head);

      const armGeo = new THREE.BoxGeometry(0.15,0.7,0.15);
      const leftArm = new THREE.Mesh(armGeo, mat);
      const rightArm = leftArm.clone();
      leftArm.position.set(-0.35,1.15,0);
      rightArm.position.set( 0.35,1.15,0);
      player.add(leftArm, rightArm);

      const legGeo = new THREE.BoxGeometry(0.2,0.8,0.2);
      const leftLeg = new THREE.Mesh(legGeo, mat);
      const rightLeg = leftLeg.clone();
      leftLeg.position.set(-0.15,0.4,0);
      rightLeg.position.set( 0.15,0.4,0);
      player.add(leftLeg, rightLeg);
    }

    function createBase() {
      const wallMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
      const buildMat = new THREE.MeshStandardMaterial({ color: 0x666666 });

      const wallV = new THREE.BoxGeometry(1,3,50);
      const wallH = new THREE.BoxGeometry(50,3,1);
      [[-25,0],[25,0]].forEach(([x,z])=>{
        const w = new THREE.Mesh(wallV, wallMat);
        w.position.set(x,1.5,z);
        scene.add(w);
      });
      [[0,-25],[0,25]].forEach(([x,z])=>{
        const w = new THREE.Mesh(wallH, wallMat);
        w.position.set(x,1.5,z);
        scene.add(w);
      });

      const barracks = new THREE.Mesh(new THREE.BoxGeometry(10,3,6), buildMat);
      barracks.position.set(-10,1.5,-10);
      scene.add(barracks);

      const cmd = new THREE.Mesh(new THREE.BoxGeometry(6,4,6), buildMat);
      cmd.position.set(10,2,-10);
      scene.add(cmd);

      const hangar = new THREE.Mesh(new THREE.BoxGeometry(14,5,10), buildMat);
      hangar.position.set(0,2.5,10);
      scene.add(hangar);

      for (let i=0; i<10; i++){
        const box = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), wallMat);
        box.position.set((Math.random()-0.5)*20,0.5,(Math.random()-0.5)*20);
        scene.add(box);
      }
    }

    function createTargets() {
      const geo = new THREE.BoxGeometry(1,1,1);
      const mat = new THREE.MeshStandardMaterial({ color: 0xff3333 });
      for (let i=0; i<20; i++){
        const t = new THREE.Mesh(geo, mat);
        t.position.set((Math.random()-0.5)*50,0.5,-Math.random()*50);
        scene.add(t);
        targets.push(t);
      }
    }

    function setupControls() {
      document.addEventListener('keydown', e=>{
        if(e.code==='ArrowUp')    move.forward= 1;
        if(e.code==='ArrowDown')  move.forward=-1;
        if(e.code==='ArrowLeft')  move.turn   =  1;
        if(e.code==='ArrowRight') move.turn   = -1;
      });
      document.addEventListener('keyup', e=>{
        if(e.code==='ArrowUp'||e.code==='ArrowDown')  move.forward=0;
        if(e.code==='ArrowLeft'||e.code==='ArrowRight')move.turn   =0;
      });
      document.addEventListener('mousedown', shoot);
    }

    function shoot(event) {
      // Нормализуем координаты клика
      mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
      mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);

      // Найдём точку на плоскости земли
      const point = new THREE.Vector3();
      raycaster.ray.intersectPlane(groundPlane, point);

      // Создаём пулю
      const geo = new THREE.SphereGeometry(0.1,8,8);
      const mat = new THREE.MeshBasicMaterial({ color:0xffff00 });
      const b = new THREE.Mesh(geo, mat);
      b.position.copy(player.position).add(new THREE.Vector3(0,1,0));

      // Направление от пули к точке клика
      const dir = point.clone().sub(b.position).normalize();
      b.userData.velocity = dir.multiplyScalar(50);

      scene.add(b);
      bullets.push(b);
    }

    function animate() {
      requestAnimationFrame(animate);
      const dt = clock.getDelta();

      // Поворот и движение игрока
      player.rotation.y += move.turn * turnSpeed * dt;
      const yaw = player.rotation.y;
      const fv = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
      player.position.addScaledVector(fv, move.forward * speed * dt);

      // Камера за спиной
      const offset = new THREE.Vector3(0,2,5)
        .applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
      camera.position.copy(player.position).add(offset);
      camera.lookAt(player.position.clone().add(new THREE.Vector3(0,1,0)));

      // Обновляем пули и проверяем попадания
      bullets = bullets.filter(b=>{
        b.position.addScaledVector(b.userData.velocity, dt);
        if(b.position.length()>200){ scene.remove(b); return false; }
        targets.forEach((t,i)=>{
          if(b.position.distanceTo(t.position)<0.6){
            scene.remove(t); targets.splice(i,1);
            kills++;
            document.getElementById('kills').textContent = 'Убито: '+kills;
          }
        });
        return true;
      });

      renderer.render(scene, camera);
    }

    function onResize() {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    }
  </script>
</body>
</html>
